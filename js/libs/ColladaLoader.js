THREE.ColladaLoader=function(){function k(e,t,n,r){var s=0;if(document.implementation&&document.implementation.createDocument){var o=new XMLHttpRequest;o.onreadystatechange=function(){o.readyState===4?o.status===0||o.status===200?o.response?(i=t,L(o.response,undefined,e)):r?r({type:"error",url:e}):console.error("ColladaLoader: Empty or non-existing file ("+e+")"):r?r({type:"error",url:e}):console.error("ColladaLoader: Couldn't load \""+e+'" ('+o.status+")"):o.readyState===3&&n&&(s===0&&(s=o.getResponseHeader("Content-Length")),n({total:s,loaded:o.responseText.length}))},o.open("GET",e,!0),o.send(null)}else alert("Don't know how to parse XML!")}function L(s,E,S){e=(new DOMParser).parseFromString(s,"text/xml"),E=E||i;if(S!==undefined){var x=S.split("/");x.pop(),y=(x.length<1?".":x.join("/"))+"/"}O(),tn(),o=M("library_images image",rt,"image"),l=M("library_materials material",xt,"material"),c=M("library_effects effect",Lt,"effect"),f=M("library_geometries geometry",pt,"geometry"),h=M("library_cameras camera",Pt,"camera"),p=M("library_lights light",Bt,"light"),a=M("library_controllers controller",it,"controller"),u=M("library_animations animation",Ot,"animation"),m=M("library_visual_scenes visual_scene",ut,"visual_scene"),g=M("library_kinematics_models kinematics_model",Ft,"kinematics_model"),b=[],w=[],n=_(),t=new THREE.Group;for(var N=0;N<n.nodes.length;N++)t.add(X(n.nodes[N]));t.scale.multiplyScalar(T),P(),r=D(),W();var C={scene:t,morphs:b,skins:w,animations:d,kinematics:v,dae:{images:o,materials:l,cameras:h,lights:p,effects:c,geometries:f,controllers:a,animations:u,visualScenes:m,visualScene:n,scene:n,kinematicsModels:g,kinematicsModel:r}};return E&&E(C),C}function A(e){S=e}function O(){var t=e.querySelectorAll("asset"),n=t[0];if(n&&n.childNodes)for(var r=0;r<n.childNodes.length;r++){var i=n.childNodes[r];switch(i.nodeName){case"unit":var s=i.getAttribute("meter");s&&(T=parseFloat(s));break;case"up_axis":N=i.textContent.charAt(0)}}}function M(t,n,r){var i=e.querySelectorAll(t),s={},o=0,u=i.length;for(var a=0;a<u;a++){var f=i[a],l=(new n).parse(f);if(!l.id||l.id.length===0)l.id=r+o++;s[l.id]=l}return s}function _(){var t=e.querySelectorAll("scene instance_visual_scene")[0];if(t){var n=t.getAttribute("url").replace(/^#/,"");return m[n.length>0?n:"visual_scene0"]}return null}function D(){var t=e.querySelectorAll("instance_kinematics_model")[0];if(t){var n=t.getAttribute("url").replace(/^#/,"");return g[n.length>0?n:"kinematics_model0"]}return null}function P(){d=[],H(t)}function H(e){var t=n.getChildById(e.colladaId,!0),r=null;if(t&&t.keys){r={fps:60,hierarchy:[{node:t,keys:t.keys,sids:t.sids}],node:e,name:"animation_"+e.name,length:0},d.push(r);for(var i=0,s=t.keys.length;i<s;i++)r.length=Math.max(r.length,t.keys[i].time)}else r={hierarchy:[{keys:[],sids:[]}]};for(var i=0,s=e.children.length;i<s;i++){var o=H(e.children[i]);for(var u=0,a=o.hierarchy.length;u<a;u++)r.hierarchy.push({keys:[],sids:[]})}return r}function B(){var e=1e6,t=-e,n=0,r;for(var i in u){var s=u[i];r=r||s.id;for(var o=0;o<s.sampler.length;o++){var a=s.sampler[o];a.create(),e=Math.min(e,a.startTime),t=Math.max(t,a.endTime),n=Math.max(n,a.input.length)}}return{start:e,end:t,frames:n,ID:r}}function j(e,t){var n=t instanceof lt?a[t.url]:t;if(!n||!n.morph){console.log("could not find morph controller!");return}var r=n.morph;for(var i=0;i<r.targets.length;i++){var s=r.targets[i],o=f[s];if(!o.mesh||!o.mesh.primitives||!o.mesh.primitives.length)continue;var u=o.mesh.primitives[0].geometry;u.vertices.length===e.vertices.length&&e.morphTargets.push({name:"target_1",vertices:u.vertices})}e.morphTargets.push({name:"target_Z",vertices:e.vertices})}function F(e,t,r){var i=a[t.url];if(!i||!i.skin){console.log("could not find skin controller!");return}if(!t.skeleton||!t.skeleton.length){console.log("could not find the skeleton for the skin!");return}var s=i.skin,o=n.getChildById(t.skeleton[0]),u=[];r=r!==undefined?r:!0;var f=[];e.skinWeights=[],e.skinIndices=[];if(r)for(var l=0;l<e.vertices.length;l++)e.vertices[l].applyMatrix4(s.bindShapeMatrix)}function I(e,t,n,r){e.world=e.world||new THREE.Matrix4,e.localworld=e.localworld||new THREE.Matrix4,e.world.copy(e.matrix),e.localworld.copy(e.matrix);if(e.channels&&e.channels.length){var i=e.channels[0],s=i.sampler.output[n];s instanceof THREE.Matrix4&&(e.world.copy(s),e.localworld.copy(s),n===0&&e.matrix.copy(s))}r&&e.world.multiplyMatrices(r,e.world),t.push(e);for(var o=0;o<e.nodes.length;o++)I(e.nodes[o],t,n,e.world)}function q(e,t){for(var n=0;n<e.length;n++){var r=e[n],i=-1;if(r.type!="JOINT")continue;for(var s=0;s<t.joints.length;s++)if(r.sid===t.joints[s]){i=s;break}if(i>=0){var o=t.invBindMatrices[i];r.invBindMatrix=o,r.skinningMatrix=new THREE.Matrix4,r.skinningMatrix.multiplyMatrices(r.world,o),r.animatrix=new THREE.Matrix4,r.animatrix.copy(r.localworld),r.weights=[];for(var s=0;s<t.weights.length;s++)for(var u=0;u<t.weights[s].length;u++){var a=t.weights[s][u];a.joint===i&&r.weights.push(a)}}else console.warn("ColladaLoader: Could not find joint '"+r.sid+"'."),r.skinningMatrix=new THREE.Matrix4,r.weights=[]}}function R(e){var t=[],n=function(e,t,r){var i={};i.name=t.sid,i.parent=e,i.matrix=t.matrix;var s=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];i.matrix.decompose(s[0],s[1],s[2]),i.pos=[s[0].x,s[0].y,s[0].z],i.scl=[s[2].x,s[2].y,s[2].z],i.rotq=[s[1].x,s[1].y,s[1].z,s[1].w],r.push(i);for(var o in t.nodes)n(t.sid,t.nodes[o],r)};return n(-1,e,t),t}function U(e,t,n){var r=[];I(t,r,-1),q(r,n.skin);var i=new THREE.Vector3,s=[];for(var o=0;o<e.vertices.length;o++)s.push(new THREE.Vector3);for(o=0;o<r.length;o++){if(r[o].type!="JOINT")continue;for(var u=0;u<r[o].weights.length;u++){var a=r[o].weights[u],f=a.index,l=a.weight,c=e.vertices[f],h=s[f];i.x=c.x,i.y=c.y,i.z=c.z,i.applyMatrix4(r[o].skinningMatrix),h.x+=i.x*l,h.y+=i.y*l,h.z+=i.z*l}}for(var o=0;o<e.vertices.length;o++)e.vertices[o]=s[o]}function z(e,t,r){var i=a[t.url];r=r!==undefined?r:40;if(!i||!i.skin){console.log("ColladaLoader: Could not find skin controller.");return}if(!t.skeleton||!t.skeleton.length){console.log("ColladaLoader: Could not find the skeleton for the skin. ");return}var s=B(),o=n.getChildById(t.skeleton[0],!0)||n.getChildBySid(t.skeleton[0],!0),u=R(o),f=i.skin.joints,l=[];for(var c=0;c<f.length;c++)for(var h=0;h<u.length;h++)u[h].name===f[c]&&(l[c]=u[h]);for(var c=0;c<l.length;c++)for(var h=0;h<l.length;h++)l[c].parent===l[h].name&&(l[c].parent=h);var c,h,p,d,v,m=new THREE.Vector3,g,y;for(c=0;c<e.vertices.length;c++)e.vertices[c].applyMatrix4(i.skin.bindShapeMatrix);var b=[],w=[],E=i.skin.weights;for(var c=0;c<E.length;c++){var S=new THREE.Vector4(E[c][0]?E[c][0].joint:0,E[c][1]?E[c][1].joint:0,E[c][2]?E[c][2].joint:0,E[c][3]?E[c][3].joint:0),v=new THREE.Vector4(E[c][0]?E[c][0].weight:0,E[c][1]?E[c][1].weight:0,E[c][2]?E[c][2].weight:0,E[c][3]?E[c][3].weight:0);b.push(S),w.push(v)}e.skinIndices=b,e.skinWeights=w,e.bones=l;var x={name:s.ID,fps:30,length:s.frames/30,hierarchy:[]};for(var h=0;h<l.length;h++)x.hierarchy.push({parent:l[h].parent,name:l[h].name,keys:[]});console.log("ColladaLoader:",s.ID+" has "+l.length+" bones."),U(e,o,i);for(r=0;r<s.frames;r++){var T=[],N=[];I(o,T,r),q(T,i.skin);for(var c=0;c<T.length;c++)for(var h=0;h<x.hierarchy.length;h++)if(x.hierarchy[h].name===T[c].sid){var C={};C.time=r/30,C.matrix=T[c].animatrix,r===0&&(T[c].matrix=C.matrix);var k=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];C.matrix.decompose(k[0],k[1],k[2]),C.pos=[k[0].x,k[0].y,k[0].z],C.scl=[k[2].x,k[2].y,k[2].z],C.rot=k[1],x.hierarchy[h].keys.push(C)}e.animation=x}}function W(){if(r&&r.joints.length===0){v=undefined;return}var i={},s=function(e,s){var o=s.getAttribute("id"),u=n.getChildById(o,!0),a=r.joints[e];t.traverse(function(t){t.colladaId==o&&(i[e]={node:t,transforms:u.transforms,joint:a,position:a.zeroPosition})})};v={joints:r&&r.joints,getJointValue:function(e){var t=i[e];if(t)return t.position;console.log("getJointValue: joint "+e+" doesn't exist")},setJointValue:function(e,t){var n=i[e];if(n){var r=n.joint;if(t>r.limits.max||t<r.limits.min)console.log("setJointValue: joint "+e+" value "+t+" outside of limits (min: "+r.limits.min+", max: "+r.limits.max+")");else if(r.static)console.log("setJointValue: joint "+e+" is static");else{var s=n.node,o=r.axis,a=n.transforms,f=new THREE.Matrix4,l=new THREE.Matrix4;for(u=0;u<a.length;u++){var c=a[u];if(c.sid&&c.sid.indexOf("joint"+e)!==-1)switch(r.type){case"revolute":f.multiply(l.makeRotationAxis(o,THREE.Math.degToRad(t)));break;case"prismatic":f.multiply(l.makeTranslation(o.x*t,o.y*t,o.z*t));break;default:console.warn("setJointValue: unknown joint type: "+r.type)}else switch(c.type){case"matrix":f.multiply(c.obj);break;case"translate":f.multiply(l.makeTranslation(c.obj.x,c.obj.y,c.obj.z));break;case"rotate":f.multiply(l.makeRotationAxis(c.obj,c.angle))}}var h=f.elements,p=Array.prototype.slice.call(h),d=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15]];s.matrix.set.apply(s.matrix,d),s.matrix.decompose(s.position,s.quaternion,s.scale),i[e].position=t}}else console.log("setJointValue: joint "+e+" doesn't exist")}};var o=e.querySelector("scene instance_kinematics_scene");if(o)for(var u=0;u<o.childNodes.length;u++){var a=o.childNodes[u];if(a.nodeType!=1)continue;switch(a.nodeName){case"bind_joint_axis":var f=a.getAttribute("target").split("/").pop(),l=a.querySelector("axis param").textContent,c=parseInt(l.split("joint").pop().split(".")[0]),h=e.querySelector('[sid="'+f+'"]');if(h){var p=h.parentElement;s(c,p)}break;default:}}}function X(e,t){var n=new THREE.Object3D,r=!1,i,s,o,u;for(o=0;o<e.controllers.length;o++){var d=a[e.controllers[o].url];switch(d.type){case"skin":if(f[d.skin.source]){var v=new ht;v.url=d.skin.source,v.instance_material=e.controllers[o].instance_material,e.geometries.push(v),r=!0,i=e.controllers[o]}else if(a[d.skin.source]){var m=a[d.skin.source];s=m;if(m.morph&&f[m.morph.source]){var v=new ht;v.url=m.morph.source,v.instance_material=e.controllers[o].instance_material,e.geometries.push(v)}}break;case"morph":if(f[d.morph.source]){var v=new ht;v.url=d.morph.source,v.instance_material=e.controllers[o].instance_material,e.geometries.push(v),s=e.controllers[o]}console.log("ColladaLoader: Morph-controller partially supported.");default:}}var g={};for(o=0;o<e.geometries.length;o++){var y=e.geometries[o],E=y.instance_material,S=f[y.url],T={},N=[],C=0,k;if(S){if(!S.mesh||!S.mesh.primitives)continue;n.name.length===0&&(n.name=S.id);if(E)for(u=0;u<E.length;u++){var L=E[u],A=l[L.target],O=A.instance_effect.url,M=c[O].shader,_=M.material;if(S.doubleSided){if(!(L.symbol in g)){var D=_.clone();D.side=THREE.DoubleSide,g[L.symbol]=D}_=g[L.symbol]}_.opacity=_.opacity?_.opacity:1,T[L.symbol]=C,N.push(_),k=_,k.name=A.name===null||A.name===""?A.id:A.name,C++}var P,H=k||new THREE.MeshLambertMaterial({color:14540253,side:S.doubleSided?THREE.DoubleSide:THREE.FrontSide}),B=S.mesh.geometry3js;if(C>1){H=new THREE.MultiMaterial(N);for(u=0;u<B.faces.length;u++){var F=B.faces[u];F.materialIndex=T[F.daeMaterial]}}i!==undefined?(z(B,i),B.morphTargets.length>0?(H.morphTargets=!0,H.skinning=!1):(H.morphTargets=!1,H.skinning=!0),P=new THREE.SkinnedMesh(B,H,!1),P.name="skin_"+w.length,w.push(P)):s!==undefined?(j(B,s),H.morphTargets=!0,P=new THREE.Mesh(B,H),P.name="morph_"+b.length,b.push(P)):B.isLineStrip===!0?P=new THREE.Line(B):P=new THREE.Mesh(B,H),n.add(P)}}for(o=0;o<e.cameras.length;o++){var I=e.cameras[o],q=h[I.url],R=new THREE.PerspectiveCamera(q.yfov,parseFloat(q.aspect_ratio),parseFloat(q.znear),parseFloat(q.zfar));n.add(R)}for(o=0;o<e.lights.length;o++){var U=null,W=e.lights[o],V=p[W.url];if(V&&V.technique){var $=V.color.getHex(),J=V.intensity,K=V.distance,Q=V.falloff_angle;switch(V.technique){case"directional":U=new THREE.DirectionalLight($,J,K),U.position.set(0,0,1);break;case"point":U=new THREE.PointLight($,J,K);break;case"spot":U=new THREE.SpotLight($,J,K,Q),U.position.set(0,0,1);break;case"ambient":U=new THREE.AmbientLight($)}}U&&n.add(U)}n.name=e.name||e.id||"",n.colladaId=e.id||"",n.layer=e.layer||"",n.matrix=e.matrix,n.matrix.decompose(n.position,n.quaternion,n.scale);if(x.centerGeometry&&n.geometry){var G=n.geometry.center();G.multiply(n.scale),G.applyQuaternion(n.quaternion),n.position.sub(G)}for(o=0;o<e.nodes.length;o++)n.add(X(e.nodes[o],e));return n}function V(e,t){for(var n=0;n<e.joints.length;n++)if(e.joints[n]===t)return n}function $(t){var n=e.querySelectorAll("library_nodes node");for(var r=0;r<n.length;r++){var i=n[r].attributes.getNamedItem("id");if(i&&i.value===t)return n[r]}return undefined}function J(e){var t=[],n=1e6,r=-1e6;for(var i in u){var s=u[i];for(var o=0;o<s.channel.length;o++){var a=s.channel[o],f=s.sampler[o],i=a.target.split("/")[0];i==e.id&&(f.create(),a.sampler=f,n=Math.min(n,f.startTime),r=Math.max(r,f.endTime),t.push(a))}}return t.length&&(e.startTime=n,e.endTime=r),t}function K(e){var t=1e7;for(var n=0;n<e.channels.length;n++){var r=e.channels[n].sampler;for(var i=0;i<r.input.length-1;i++){var s=r.input[i],o=r.input[i+1];t=Math.min(t,o-s)}}return t}function Q(e,t){var n={},r,i;for(r=0;r<e.channels.length;r++){var s=e.channels[r];n[s.sid]=s}var o=new THREE.Matrix4;for(r=0;r<e.transforms.length;r++){var u=e.transforms[r],s=n[u.sid];if(s!==undefined){var a=s.sampler,f;for(i=0;i<a.input.length-1;i++)if(a.input[i+1]>t){f=a.output[i];break}f!==undefined?f instanceof THREE.Matrix4?o.multiplyMatrices(o,f):o.multiplyMatrices(o,u.matrix):o.multiplyMatrices(o,u.matrix)}else o.multiplyMatrices(o,u.matrix)}return o}function G(e){if(e.channels&&e.channels.length){var t=[],n=[];for(var r=0,i=e.channels.length;r<i;r++){var s=e.channels[r],o=s.fullSid,u=s.sampler,a=u.input,f=e.getTransformBySid(s.sid),l;if(s.arrIndices){l=[];for(var c=0,h=s.arrIndices.length;c<h;c++)l[c]=un(s.arrIndices[c])}else l=an(s.member);if(f){n.indexOf(o)===-1&&n.push(o);for(var c=0,h=a.length;c<h;c++){var p=a[c],d=u.getData(f.type,c,l),v=Y(t,p);if(!v){v=new Dt(p);var m=Z(t,p);t.splice(m===-1?t.length:m,0,v)}v.addTarget(o,f,l,d)}}else console.log('Could not find transform "'+s.sid+'" in node '+e.id)}for(var r=0;r<n.length;r++){var g=n[r];for(var c=0;c<t.length;c++){var v=t[c];v.hasTarget(g)||et(t,v,c,g)}}e.keys=t,e.sids=n}}function Y(e,t){var n=null;for(var r=0,i=e.length;r<i&&n===null;r++){var s=e[r];if(s.time===t)n=s;else if(s.time>t)break}return n}function Z(e,t){var n=-1;for(var r=0,i=e.length;r<i&&n===-1;r++){var s=e[r];s.time>=t&&(n=r)}return n}function et(e,t,n,r){var i=nt(e,r,n?n-1:0),s=tt(e,r,n+1);if(i&&s){var o=(t.time-i.time)/(s.time-i.time),u=i.getTarget(r),a=s.getTarget(r).data,f=u.data,l;if(u.type==="matrix")l=f;else if(f.length){l=[];for(var c=0;c<f.length;++c)l[c]=f[c]+(a[c]-f[c])*o}else l=f+(a-f)*o;t.addTarget(r,u.transform,u.member,l)}}function tt(e,t,n){for(;n<e.length;n++){var r=e[n];if(r.hasTarget(t))return r}return null}function nt(e,t,n){n=n>=0?n:n+e.length;for(;n>=0;n--){var r=e[n];if(r.hasTarget(t))return r}return null}function rt(){this.id="",this.init_from=""}function it(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function st(){this.method=null,this.source=null,this.targets=null,this.weights=null}function ot(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function ut(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function at(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function ft(){this.sid="",this.type="",this.data=[],this.obj=null}function lt(){this.url="",this.skeleton=[],this.instance_material=[]}function ct(){this.symbol="",this.target=""}function ht(){this.url="",this.instance_material=[]}function pt(){this.id="",this.mesh=null}function dt(e){this.geometry=e.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function vt(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function mt(){vt.call(this),this.vcount=[]}function gt(){vt.call(this),this.vcount=1}function yt(){vt.call(this),this.vcount=3}function bt(){this.source="",this.count=0,this.stride=0,this.params=[]}function wt(){this.input={}}function Et(){this.semantic="",this.offset=0,this.source="",this.set=0}function St(e){this.id=e,this.type=null}function xt(){this.id="",this.name="",this.instance_effect=null}function Tt(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function Nt(e,t){this.type=e,this.effect=t,this.material=null}function Ct(e){this.effect=e,this.init_from=null,this.format=null}function kt(e){this.effect=e,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function Lt(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function At(){this.url=""}function Ot(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function Mt(e){this.animation=e,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function _t(e){this.id="",this.animation=e,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function Dt(e){this.targets=[],this.time=e}function Pt(){this.id="",this.name="",this.technique=""}function Ht(){this.url=""}function Bt(){this.id="",this.name="",this.technique=""}function jt(){this.url=""}function Ft(){this.id="",this.name="",this.joints=[],this.links=[]}function It(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0}function qt(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function Rt(){this.joint="",this.transforms=[],this.links=[]}function Ut(e){var t=e.getAttribute("id");return s[t]!=undefined?s[t]:(s[t]=(new St(t)).parse(e),s[t])}function zt(e){return e==="dae"?"http://www.collada.org/2005/11/COLLADASchema":null}function Wt(e){var t=$t(e),n=[];for(var r=0,i=t.length;r<i;r++)n.push(t[r]==="true"||t[r]==="1"?!0:!1);return n}function Xt(e){var t=$t(e),n=[];for(var r=0,i=t.length;r<i;r++)n.push(parseFloat(t[r]));return n}function Vt(e){var t=$t(e),n=[];for(var r=0,i=t.length;r<i;r++)n.push(parseInt(t[r],10));return n}function $t(e){return e.length>0?Jt(e).split(/\s+/):[]}function Jt(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")}function Kt(e,t,n){return e.hasAttribute(t)?parseFloat(e.getAttribute(t)):n}function Qt(e,t,n){return e.hasAttribute(t)?parseInt(e.getAttribute(t),10):n}function Gt(e,t,n){return e.hasAttribute(t)?e.getAttribute(t):n}function Yt(e,t){if(e===undefined){var n="0.";while(n.length<t+2)n+="0";return n}t=t||2;var r=e.toString().split(".");r[1]=r.length>1?r[1].substr(0,t):"0";while(r[1].length<t)r[1]+="0";return r.join(".")}function Zt(e,t){var n=new THREE.ImageLoader;n.load(t,function(t){e.image=t,e.needsUpdate=!0})}function en(e,t){e.doubleSided=!1;var n=t.querySelectorAll("extra double_sided")[0];n&&n&&parseInt(n.textContent,10)===1&&(e.doubleSided=!0)}function tn(){if(x.convertUpAxis!==!0||N===x.upAxis)C=null;else switch(N){case"X":C=x.upAxis==="Y"?"XtoY":"XtoZ";break;case"Y":C=x.upAxis==="X"?"YtoX":"YtoZ";break;case"Z":C=x.upAxis==="X"?"ZtoX":"ZtoY"}}function nn(e,t){if(x.convertUpAxis!==!0||N===x.upAxis)return;switch(C){case"XtoY":var n=e[0];e[0]=t*e[1],e[1]=n;break;case"XtoZ":var n=e[2];e[2]=e[1],e[1]=e[0],e[0]=n;break;case"YtoX":var n=e[0];e[0]=e[1],e[1]=t*n;break;case"YtoZ":var n=e[1];e[1]=t*e[2],e[2]=n;break;case"ZtoX":var n=e[0];e[0]=e[1],e[1]=e[2],e[2]=n;break;case"ZtoY":var n=e[1];e[1]=e[2],e[2]=t*n}}function rn(e,t){if(x.convertUpAxis!==!0||N===x.upAxis)return t;switch(e){case"X":t=C==="XtoY"?t*-1:t;break;case"Y":t=C==="YtoZ"||C==="YtoX"?t*-1:t;break;case"Z":t=C==="ZtoY"?t*-1:t;break;default:}return t}function sn(e,t){var n=[e[t],e[t+1],e[t+2]];return nn(n,-1),new THREE.Vector3(n[0],n[1],n[2])}function on(e){if(x.convertUpAxis){var t=[e[0],e[4],e[8]];nn(t,-1),e[0]=t[0],e[4]=t[1],e[8]=t[2],t=[e[1],e[5],e[9]],nn(t,-1),e[1]=t[0],e[5]=t[1],e[9]=t[2],t=[e[2],e[6],e[10]],nn(t,-1),e[2]=t[0],e[6]=t[1],e[10]=t[2],t=[e[0],e[1],e[2]],nn(t,-1),e[0]=t[0],e[1]=t[1],e[2]=t[2],t=[e[4],e[5],e[6]],nn(t,-1),e[4]=t[0],e[5]=t[1],e[6]=t[2],t=[e[8],e[9],e[10]],nn(t,-1),e[8]=t[0],e[9]=t[1],e[10]=t[2],t=[e[3],e[7],e[11]],nn(t,-1),e[3]=t[0],e[7]=t[1],e[11]=t[2]}return(new THREE.Matrix4).set(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])}function un(e){if(e>-1&&e<3){var t=["X","Y","Z"],n={X:0,Y:1,Z:2};e=an(t[e]),e=n[e]}return e}function an(e){if(x.convertUpAxis)switch(e){case"X":switch(C){case"XtoY":case"XtoZ":case"YtoX":e="Y";break;case"ZtoX":e="Z"}break;case"Y":switch(C){case"XtoY":case"YtoX":case"ZtoX":e="X";break;case"XtoZ":case"YtoZ":case"ZtoY":e="Z"}break;case"Z":switch(C){case"XtoZ":e="X";break;case"YtoZ":case"ZtoX":case"ZtoY":e="Y"}}return e}var e=null,t=null,n,r,i=null,s={},o={},u={},a={},f={},l={},c={},h={},p={},d,v,m,g,y,b,w,E=!0,S=THREE.SmoothShading,x={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},T=1,N="Y",C=null;return rt.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];n.nodeName==="init_from"&&(this.init_from=n.textContent)}return this},it.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.type="none";for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"skin":this.skin=(new ot).parse(n),this.type=n.nodeName;break;case"morph":this.morph=(new st).parse(n),this.type=n.nodeName;break;default:}}return this},st.prototype.parse=function(e){var t={},n=[],r;this.method=e.getAttribute("method"),this.source=e.getAttribute("source").replace(/^#/,"");for(r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(i.nodeType!=1)continue;switch(i.nodeName){case"source":var s=(new St).parse(i);t[s.id]=s;break;case"targets":n=this.parseInputs(i);break;default:console.log(i.nodeName)}}for(r=0;r<n.length;r++){var o=n[r],s=t[o.source];switch(o.semantic){case"MORPH_TARGET":this.targets=s.read();break;case"MORPH_WEIGHT":this.weights=s.read();break;default:}}return this},st.prototype.parseInputs=function(e){var t=[];for(var n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];if(r.nodeType!=1)continue;switch(r.nodeName){case"input":t.push((new Et).parse(r));break;default:}}return t},ot.prototype.parse=function(e){var t={},n,r;this.source=e.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(s.nodeType!=1)continue;switch(s.nodeName){case"bind_shape_matrix":var o=Xt(s.textContent);this.bindShapeMatrix=on(o);break;case"source":var u=(new St).parse(s);t[u.id]=u;break;case"joints":n=s;break;case"vertex_weights":r=s;break;default:console.log(s.nodeName)}}return this.parseJoints(n,t),this.parseWeights(r,t),this},ot.prototype.parseJoints=function(e,t){for(var n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];if(r.nodeType!=1)continue;switch(r.nodeName){case"input":var i=(new Et).parse(r),s=t[i.source];i.semantic==="JOINT"?this.joints=s.read():i.semantic==="INV_BIND_MATRIX"&&(this.invBindMatrices=s.read());break;default:}}},ot.prototype.parseWeights=function(e,t){var n,r,i=[];for(var s=0;s<e.childNodes.length;s++){var o=e.childNodes[s];if(o.nodeType!=1)continue;switch(o.nodeName){case"input":i.push((new Et).parse(o));break;case"v":n=Vt(o.textContent);break;case"vcount":r=Vt(o.textContent);break;default:}}var u=0;for(var s=0;s<r.length;s++){var a=r[s],f=[];for(var l=0;l<a;l++){var c={};for(var h=0;h<i.length;h++){var p=i[h],d=n[u+p.offset];switch(p.semantic){case"JOINT":c.joint=d;break;case"WEIGHT":c.weight=t[p.source].data[d];break;default:}}f.push(c),u+=i.length}for(var l=0;l<f.length;l++)f[l].index=s;this.weights.push(f)}},ut.prototype.getChildById=function(e,t){for(var n=0;n<this.nodes.length;n++){var r=this.nodes[n].getChildById(e,t);if(r)return r}return null},ut.prototype.getChildBySid=function(e,t){for(var n=0;n<this.nodes.length;n++){var r=this.nodes[n].getChildBySid(e,t);if(r)return r}return null},ut.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.nodes=[];for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"node":this.nodes.push((new at).parse(n));break;default:}}return this},at.prototype.getChannelForTransform=function(e){for(var t=0;t<this.channels.length;t++){var n=this.channels[t],r=n.target.split("/"),i=r.shift(),s=r.shift(),o=s.indexOf(".")>=0,u=s.indexOf("(")>=0,a,f;if(o)r=s.split("."),s=r.shift(),f=r.shift();else if(u){a=s.split("("),s=a.shift();for(var l=0;l<a.length;l++)a[l]=parseInt(a[l].replace(/\)/,""))}if(s===e)return n.info={sid:s,dotSyntax:o,arrSyntax:u,arrIndices:a},n}return null},at.prototype.getChildById=function(e,t){if(this.id===e)return this;if(t)for(var n=0;n<this.nodes.length;n++){var r=this.nodes[n].getChildById(e,t);if(r)return r}return null},at.prototype.getChildBySid=function(e,t){if(this.sid===e)return this;if(t)for(var n=0;n<this.nodes.length;n++){var r=this.nodes[n].getChildBySid(e,t);if(r)return r}return null},at.prototype.getTransformBySid=function(e){for(var t=0;t<this.transforms.length;t++)if(this.transforms[t].sid===e)return this.transforms[t];return null},at.prototype.parse=function(e){var t;this.id=e.getAttribute("id"),this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.type=e.getAttribute("type"),this.layer=e.getAttribute("layer"),this.type=this.type==="JOINT"?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];if(r.nodeType!=1)continue;switch(r.nodeName){case"node":this.nodes.push((new at).parse(r));break;case"instance_camera":this.cameras.push((new Ht).parse(r));break;case"instance_controller":this.controllers.push((new lt).parse(r));break;case"instance_geometry":this.geometries.push((new ht).parse(r));break;case"instance_light":this.lights.push((new jt).parse(r));break;case"instance_node":t=r.getAttribute("url").replace(/^#/,"");var i=$(t);i&&this.nodes.push((new at).parse(i));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new ft).parse(r));break;case"extra":break;default:console.log(r.nodeName)}}return this.channels=J(this),G(this),this.updateMatrix(),this},at.prototype.updateMatrix=function(){this.matrix.identity();for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(this.matrix)},ft.prototype.parse=function(e){return this.sid=e.getAttribute("sid"),this.type=e.nodeName,this.data=Xt(e.textContent),this.convert(),this},ft.prototype.convert=function(){switch(this.type){case"matrix":this.obj=on(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":nn(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":nn(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},ft.prototype.apply=function(){var e=new THREE.Matrix4;return function(t){switch(this.type){case"matrix":t.multiply(this.obj);break;case"translate":t.multiply(e.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":t.multiply(e.makeRotationAxis(this.obj,this.angle));break;case"scale":t.scale(this.obj)}}}(),ft.prototype.update=function(e,t){var n=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(!t)this.obj.copy(e);else if(t.length===1)switch(t[0]){case 0:this.obj.n11=e[0],this.obj.n21=e[1],this.obj.n31=e[2],this.obj.n41=e[3];break;case 1:this.obj.n12=e[0],this.obj.n22=e[1],this.obj.n32=e[2],this.obj.n42=e[3];break;case 2:this.obj.n13=e[0],this.obj.n23=e[1],this.obj.n33=e[2],this.obj.n43=e[3];break;case 3:this.obj.n14=e[0],this.obj.n24=e[1],this.obj.n34=e[2],this.obj.n44=e[3]}else if(t.length===2){var r="n"+(t[0]+1)+(t[1]+1);this.obj[r]=e}else console.log("Incorrect addressing of matrix in transform.");break;case"translate":case"scale":Object.prototype.toString.call(t)==="[object Array]"&&(t=n[t[0]]);switch(t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2]}break;case"rotate":Object.prototype.toString.call(t)==="[object Array]"&&(t=n[t[0]]);switch(t){case"X":this.obj.x=e;break;case"Y":this.obj.y=e;break;case"Z":this.obj.z=e;break;case"ANGLE":this.angle=THREE.Math.degToRad(e);break;default:this.obj.x=e[0],this.obj.y=e[1],this.obj.z=e[2],this.angle=THREE.Math.degToRad(e[3])}}},lt.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!==1)continue;switch(n.nodeName){case"skeleton":this.skeleton.push(n.textContent.replace(/^#/,""));break;case"bind_material":var r=n.querySelectorAll("instance_material");for(var i=0;i<r.length;i++){var s=r[i];this.instance_material.push((new ct).parse(s))}break;case"extra":break;default:}}return this},ct.prototype.parse=function(e){return this.symbol=e.getAttribute("symbol"),this.target=e.getAttribute("target").replace(/^#/,""),this},ht.prototype.parse=function(e){this.url=e.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;if(n.nodeName==="bind_material"){var r=n.querySelectorAll("instance_material");for(var i=0;i<r.length;i++){var s=r[i];this.instance_material.push((new ct).parse(s))}break}}return this},pt.prototype.parse=function(e){this.id=e.getAttribute("id"),en(this,e);for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"mesh":this.mesh=(new dt(this)).parse(n);break;case"extra":break;default:}}return this},dt.prototype.parse=function(e){this.primitives=[];for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"source":Ut(n);break;case"vertices":this.vertices=(new wt).parse(n);break;case"linestrips":this.primitives.push((new gt).parse(n));break;case"triangles":this.primitives.push((new yt).parse(n));break;case"polygons":this.primitives.push((new vt).parse(n));break;case"polylist":this.primitives.push((new mt).parse(n));break;default:}}this.geometry3js=new THREE.Geometry;if(this.vertices===null)return this;var r=s[this.vertices.input.POSITION.source].data;for(var t=0;t<r.length;t+=3)this.geometry3js.vertices.push(sn(r,t).clone());for(var t=0;t<this.primitives.length;t++){var i=this.primitives[t];i.setVertices(this.vertices),this.handlePrimitive(i,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},dt.prototype.handlePrimitive=function(e,t){if(e instanceof gt){t.isLineStrip=!0;return}var n,r,i=e.p,o=e.inputs,u,a,f,l,c,h=0,p=3,d=0,v=[];for(n=0;n<o.length;n++){u=o[n];var m=u.offset+1;d=d<m?m:d;switch(u.semantic){case"TEXCOORD":v.push(u.set)}}for(var g=0;g<i.length;++g){var y=i[g],b=0;while(b<y.length){var w=[],E=[],S=null,T=[];e.vcount?p=e.vcount.length?e.vcount[h++]:e.vcount:p=y.length/d;for(n=0;n<p;n++)for(r=0;r<o.length;r++){u=o[r],l=s[u.source],a=y[b+n*d+u.offset],c=l.accessor.params.length,f=a*c;switch(u.semantic){case"VERTEX":w.push(a);break;case"NORMAL":E.push(sn(l.data,f));break;case"TEXCOORD":S=S||{},S[u.set]===undefined&&(S[u.set]=[]),S[u.set].push(new THREE.Vector2(l.data[f],l.data[f+1]));break;case"COLOR":T.push((new THREE.Color).setRGB(l.data[f],l.data[f+1],l.data[f+2]));break;default:}}if(E.length===0){u=this.vertices.input.NORMAL;if(u){l=s[u.source],c=l.accessor.params.length;for(var N=0,C=w.length;N<C;N++)E.push(sn(l.data,w[N]*c))}else t.calcNormals=!0}if(!S){S={},u=this.vertices.input.TEXCOORD;if(u){v.push(u.set),l=s[u.source],c=l.accessor.params.length;for(var N=0,C=w.length;N<C;N++)f=w[N]*c,S[u.set]===undefined&&(S[u.set]=[]),S[u.set].push(new THREE.Vector2(l.data[f],1-l.data[f+1]))}}if(T.length===0){u=this.vertices.input.COLOR;if(u){l=s[u.source],c=l.accessor.params.length;for(var N=0,C=w.length;N<C;N++)f=w[N]*c,T.push((new THREE.Color).setRGB(l.data[f],l.data[f+1],l.data[f+2]))}}var k=null,L=[],A,O;if(p===3)L.push(new THREE.Face3(w[0],w[1],w[2],E,T.length?T:new THREE.Color));else if(p===4)L.push(new 
THREE.Face3(w[0],w[1],w[3],E.length?[E[0].clone(),E[1].clone(),E[3].clone()]:[],T.length?[T[0],T[1],T[3]]:new THREE.Color)),L.push(new THREE.Face3(w[1],w[2],w[3],E.length?[E[1].clone(),E[2].clone(),E[3].clone()]:[],T.length?[T[1],T[2],T[3]]:new THREE.Color));else if(p>4&&x.subdivideFaces){var M=T.length?T:new THREE.Color,_,D,P,H,B,j;for(r=1;r<p-1;)L.push(new THREE.Face3(w[0],w[r],w[r+1],E.length?[E[0].clone(),E[r++].clone(),E[r].clone()]:[],M))}if(L.length)for(var N=0,C=L.length;N<C;N++){k=L[N],k.daeMaterial=e.material,t.faces.push(k);for(r=0;r<v.length;r++)A=S[v[r]],p>4?O=[A[0],A[N+1],A[N+2]]:p===4?N===0?O=[A[0],A[1],A[3]]:O=[A[1].clone(),A[2],A[3].clone()]:O=[A[0],A[1],A[2]],t.faceVertexUvs[r]===undefined&&(t.faceVertexUvs[r]=[]),t.faceVertexUvs[r].push(O)}else console.log("dropped face with vcount "+p+" for geometry with id: "+t.id);b+=d*p}}},vt.prototype.setVertices=function(e){for(var t=0;t<this.inputs.length;t++)this.inputs[t].source===e.id&&(this.inputs[t].source=e.input.POSITION.source)},vt.prototype.parse=function(e){this.material=e.getAttribute("material"),this.count=Qt(e,"count",0);for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"input":this.inputs.push((new Et).parse(e.childNodes[t]));break;case"vcount":this.vcount=Vt(n.textContent);break;case"p":this.p.push(Vt(n.textContent));break;case"ph":console.warn("polygon holes not yet supported!");break;default:}}return this},mt.prototype=Object.create(vt.prototype),mt.prototype.constructor=mt,gt.prototype=Object.create(vt.prototype),gt.prototype.constructor=gt,yt.prototype=Object.create(vt.prototype),yt.prototype.constructor=yt,bt.prototype.parse=function(e){this.params=[],this.source=e.getAttribute("source"),this.count=Qt(e,"count",0),this.stride=Qt(e,"stride",0);for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeName==="param"){var r={};r.name=n.getAttribute("name"),r.type=n.getAttribute("type"),this.params.push(r)}}return this},wt.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++)if(e.childNodes[t].nodeName==="input"){var n=(new Et).parse(e.childNodes[t]);this.input[n.semantic]=n}return this},Et.prototype.parse=function(e){return this.semantic=e.getAttribute("semantic"),this.source=e.getAttribute("source").replace(/^#/,""),this.set=Qt(e,"set",-1),this.offset=Qt(e,"offset",0),this.semantic==="TEXCOORD"&&this.set<0&&(this.set=0),this},St.prototype.parse=function(e){this.id=e.getAttribute("id");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"bool_array":this.data=Wt(n.textContent),this.type=n.nodeName;break;case"float_array":this.data=Xt(n.textContent),this.type=n.nodeName;break;case"int_array":this.data=Vt(n.textContent),this.type=n.nodeName;break;case"IDREF_array":case"Name_array":this.data=$t(n.textContent),this.type=n.nodeName;break;case"technique_common":for(var r=0;r<n.childNodes.length;r++)if(n.childNodes[r].nodeName==="accessor"){this.accessor=(new bt).parse(n.childNodes[r]);break}break;default:}}return this},St.prototype.read=function(){var e=[],t=this.accessor.params[0];switch(t.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var n=0;n<this.data.length;n+=16){var r=this.data.slice(n,n+16),i=on(r);e.push(i)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+t.type+".")}return e},xt.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++)if(e.childNodes[t].nodeName==="instance_effect"){this.instance_effect=(new At).parse(e.childNodes[t]);break}return this},Tt.prototype.isColor=function(){return this.texture===null},Tt.prototype.isTexture=function(){return this.texture!=null},Tt.prototype.parse=function(e){e.nodeName==="transparent"&&(this.opaque=e.getAttribute("opaque"));for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"color":var r=Xt(n.textContent);this.color=new THREE.Color,this.color.setRGB(r[0],r[1],r[2]),this.color.a=r[3];break;case"texture":this.texture=n.getAttribute("texture"),this.texcoord=n.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(n);break;default:}}return this},Tt.prototype.parseTexture=function(e){if(!e.childNodes)return this;e.childNodes[1]&&e.childNodes[1].nodeName==="extra"&&(e=e.childNodes[1],e.childNodes[1]&&e.childNodes[1].nodeName==="technique"&&(e=e.childNodes[1]));for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[n.nodeName]=parseFloat(n.textContent);break;case"wrapU":case"wrapV":n.textContent.toUpperCase()==="TRUE"?this.texOpts[n.nodeName]=1:this.texOpts[n.nodeName]=parseInt(n.textContent);break;default:this.texOpts[n.nodeName]=n.textContent}}return this},Nt.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[n.nodeName]=(new Tt).parse(n);break;case"bump":var r=n.getAttribute("bumptype");r?r.toLowerCase()==="heightfield"?this.bump=(new Tt).parse(n):r.toLowerCase()==="normalmap"?this.normal=(new Tt).parse(n):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+r+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new Tt).parse(n)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new Tt).parse(n));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var i=n.querySelectorAll("float");i.length>0&&(this[n.nodeName]=parseFloat(i[0].textContent));break;default:}}return this.create(),this},Nt.prototype.create=function(){var e={},t=!1;if(this.transparency!==undefined&&this.transparent!==undefined){var n=this.transparent,r=(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency;r>0&&(t=!0,e.transparent=!0,e.opacity=1-r)}var i={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var s in this)switch(s){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var u=this[s];if(u instanceof Tt)if(u.isTexture()){var a=u.texture,f=this.effect.sampler[a];if(f!==undefined&&f.source!==undefined){var l=this.effect.surface[f.source];if(l!==undefined){var c=o[l.init_from];if(c){var h=y+c.init_from,p,d=THREE.Loader.Handlers.get(h);d!==null?p=d.load(h):(p=new THREE.Texture,Zt(p,h)),f.wrap_s==="MIRROR"?p.wrapS=THREE.MirroredRepeatWrapping:f.wrap_s==="WRAP"||u.texOpts.wrapU?p.wrapS=THREE.RepeatWrapping:p.wrapS=THREE.ClampToEdgeWrapping,f.wrap_t==="MIRROR"?p.wrapT=THREE.MirroredRepeatWrapping:f.wrap_t==="WRAP"||u.texOpts.wrapV?p.wrapT=THREE.RepeatWrapping:p.wrapT=THREE.ClampToEdgeWrapping,p.offset.x=u.texOpts.offsetU,p.offset.y=u.texOpts.offsetV,p.repeat.x=u.texOpts.repeatU,p.repeat.y=u.texOpts.repeatV,e[i[s]]=p,s==="emission"&&(e.emissive=16777215)}}}}else if(s==="diffuse"||!t)s==="emission"?e.emissive=u.color.getHex():e[s]=u.color.getHex();break;case"shininess":e[s]=this[s];break;case"reflectivity":e[s]=this[s],e[s]>0&&(e.envMap=x.defaultEnvMap),e.combine=THREE.MixOperation;break;case"index_of_refraction":e.refractionRatio=this[s],this[s]!==1&&(e.envMap=x.defaultEnvMap);break;case"transparency":break;default:}e.shading=S,e.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,e.diffuse!==undefined&&(e.color=e.diffuse,delete e.diffuse);switch(this.type){case"constant":e.emissive!=undefined&&(e.color=e.emissive),this.material=new THREE.MeshBasicMaterial(e);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(e);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(e)}return this.material},Ct.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"init_from":this.init_from=n.textContent;break;case"format":this.format=n.textContent;break;default:console.log("unhandled Surface prop: "+n.nodeName)}}return this},kt.prototype.parse=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"source":this.source=n.textContent;break;case"minfilter":this.minfilter=n.textContent;break;case"magfilter":this.magfilter=n.textContent;break;case"mipfilter":this.mipfilter=n.textContent;break;case"wrap_s":this.wrap_s=n.textContent;break;case"wrap_t":this.wrap_t=n.textContent;break;default:console.log("unhandled Sampler2D prop: "+n.nodeName)}}return this},Lt.prototype.create=function(){if(this.shader===null)return null},Lt.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),en(this,e),this.shader=null;for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(n));break;default:}}return this},Lt.prototype.parseNewparam=function(e){var t=e.getAttribute("sid");for(var n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];if(r.nodeType!=1)continue;switch(r.nodeName){case"surface":this.surface[t]=(new Ct(this)).parse(r);break;case"sampler2D":this.sampler[t]=(new kt(this)).parse(r);break;case"extra":break;default:console.log(r.nodeName)}}},Lt.prototype.parseProfileCOMMON=function(e){var t;for(var n=0;n<e.childNodes.length;n++){var r=e.childNodes[n];if(r.nodeType!=1)continue;switch(r.nodeName){case"profile_COMMON":this.parseProfileCOMMON(r);break;case"technique":t=r;break;case"newparam":this.parseNewparam(r);break;case"image":var i=(new rt).parse(r);o[i.id]=i;break;case"extra":break;default:console.log(r.nodeName)}}return t},Lt.prototype.parseTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=(new Nt(n.nodeName,this)).parse(n);break;case"extra":this.parseExtra(n);break;default:}}},Lt.prototype.parseExtra=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"technique":this.parseExtraTechnique(n);break;default:}}},Lt.prototype.parseExtraTechnique=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"bump":this.shader.parse(e);break;default:}}},At.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},Ot.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.source={};for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"animation":var r=(new Ot).parse(n);for(var i in r.source)this.source[i]=r.source[i];for(var s=0;s<r.channel.length;s++)this.channel.push(r.channel[s]),this.sampler.push(r.sampler[s]);break;case"source":var i=(new St).parse(n);this.source[i.id]=i;break;case"sampler":this.sampler.push((new _t(this)).parse(n));break;case"channel":this.channel.push((new Mt(this)).parse(n));break;default:}}return this},Mt.prototype.parse=function(e){this.source=e.getAttribute("source").replace(/^#/,""),this.target=e.getAttribute("target");var t=this.target.split("/"),n=t.shift(),r=t.shift(),i=r.indexOf(".")>=0,s=r.indexOf("(")>=0;if(i)t=r.split("."),this.sid=t.shift(),this.member=t.shift();else if(s){var o=r.split("(");this.sid=o.shift();for(var u=0;u<o.length;u++)o[u]=parseInt(o[u].replace(/\)/,""));this.arrIndices=o}else this.sid=r;return this.fullSid=r,this.dotSyntax=i,this.arrSyntax=s,this},_t.prototype.parse=function(e){this.id=e.getAttribute("id"),this.inputs=[];for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"input":this.inputs.push((new Et).parse(n));break;default:}}return this},_t.prototype.create=function(){for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],n=this.animation.source[t.source];switch(t.semantic){case"INPUT":this.input=n.read();break;case"OUTPUT":this.output=n.read(),this.strideOut=n.accessor.stride;break;case"INTERPOLATION":this.interpolation=n.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(t.semantic)}}this.startTime=0,this.endTime=0,this.duration=0;if(this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var e=0;e<this.input.length;e++)this.startTime=Math.min(this.startTime,this.input[e]),this.endTime=Math.max(this.endTime,this.input[e]);this.duration=this.endTime-this.startTime}},_t.prototype.getData=function(e,t,n){var r;if(e==="matrix"&&this.strideOut===16)r=this.output[t];else if(this.strideOut>1){r=[],t*=this.strideOut;for(var i=0;i<this.strideOut;++i)r[i]=this.output[t+i];if(this.strideOut===3)switch(e){case"rotate":case"translate":nn(r,-1);break;case"scale":nn(r,1)}else this.strideOut===4&&e==="matrix"&&nn(r,-1)}else r=this.output[t],n&&e==="translate"&&(r=rn(n,r));return r},Dt.prototype.addTarget=function(e,t,n,r){this.targets.push({sid:e,member:n,transform:t,data:r})},Dt.prototype.apply=function(e){for(var t=0;t<this.targets.length;++t){var n=this.targets[t];(!e||n.sid===e)&&n.transform.update(n.data,n.member)}},Dt.prototype.getTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return this.targets[t];return null},Dt.prototype.hasTarget=function(e){for(var t=0;t<this.targets.length;++t)if(this.targets[t].sid===e)return!0;return!1},Dt.prototype.interpolate=function(e,t){for(var n=0,r=this.targets.length;n<r;n++){var i=this.targets[n],s=e.getTarget(i.sid),o;if(i.transform.type!=="matrix"&&s){var u=(t-this.time)/(e.time-this.time),a=s.data,f=i.data;u<0&&(u=0),u>1&&(u=1);if(f.length){o=[];for(var l=0;l<f.length;++l)o[l]=f[l]+(a[l]-f[l])*u}else o=f+(a-f)*u}else o=i.data;i.transform.update(o,i.member)}},Pt.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"optics":this.parseOptics(n);break;default:}}return this},Pt.prototype.parseOptics=function(e){for(var t=0;t<e.childNodes.length;t++)if(e.childNodes[t].nodeName==="technique_common"){var n=e.childNodes[t];for(var r=0;r<n.childNodes.length;r++){this.technique=n.childNodes[r].nodeName;if(this.technique==="perspective"){var i=n.childNodes[r];for(var s=0;s<i.childNodes.length;s++){var o=i.childNodes[s];switch(o.nodeName){case"yfov":this.yfov=o.textContent;break;case"xfov":this.xfov=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}}else if(this.technique==="orthographic"){var u=n.childNodes[r];for(var s=0;s<u.childNodes.length;s++){var o=u.childNodes[s];switch(o.nodeName){case"xmag":this.xmag=o.textContent;break;case"ymag":this.ymag=o.textContent;break;case"znear":this.znear=o.textContent;break;case"zfar":this.zfar=o.textContent;break;case"aspect_ratio":this.aspect_ratio=o.textContent}}}}}return this},Ht.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},Bt.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"technique_common":this.parseCommon(n);break;case"technique":this.parseTechnique(n);break;default:}}return this},Bt.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++)switch(e.childNodes[t].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=e.childNodes[t].nodeName;var n=e.childNodes[t];for(var r=0;r<n.childNodes.length;r++){var i=n.childNodes[r];switch(i.nodeName){case"color":var s=Xt(i.textContent);this.color=new THREE.Color(0),this.color.setRGB(s[0],s[1],s[2]),this.color.a=s[3];break;case"falloff_angle":this.falloff_angle=parseFloat(i.textContent);break;case"quadratic_attenuation":var o=parseFloat(i.textContent);this.distance=o?Math.sqrt(1/o):0}}}return this},Bt.prototype.parseTechnique=function(e){this.profile=e.getAttribute("profile");for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];switch(n.nodeName){case"intensity":this.intensity=parseFloat(n.textContent)}}return this},jt.prototype.parse=function(e){return this.url=e.getAttribute("url").replace(/^#/,""),this},Ft.prototype.parse=function(e){this.id=e.getAttribute("id"),this.name=e.getAttribute("name"),this.joints=[],this.links=[];for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"technique_common":this.parseCommon(n);break;default:}}return this},Ft.prototype.parseCommon=function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(e.childNodes[t].nodeName){case"joint":this.joints.push((new It).parse(n));break;case"link":this.links.push((new qt).parse(n));break;default:}}return this},It.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this.static=!1,this.zeroPosition=0,this.middlePosition=0;var t=e.querySelector("axis"),n=Xt(t.textContent);this.axis=sn(n,0);var r=e.querySelector("limits min")?parseFloat(e.querySelector("limits min").textContent):-360,i=e.querySelector("limits max")?parseFloat(e.querySelector("limits max").textContent):360;this.limits={min:r,max:i};var s=["prismatic","revolute"];for(var o=0;o<s.length;o++){var u=s[o],a=e.querySelector(u);a&&(this.type=u)}return this.limits.min>=this.limits.max&&(this.static=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},qt.prototype.parse=function(e){this.sid=e.getAttribute("sid"),this.name=e.getAttribute("name"),this.transforms=[],this.attachments=[];for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"attachment_full":this.attachments.push((new Rt).parse(n));break;case"rotate":case"translate":case"matrix":this.transforms.push((new ft).parse(n));break;default:}}return this},Rt.prototype.parse=function(e){this.joint=e.getAttribute("joint").split("/").pop(),this.links=[];for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(n.nodeType!=1)continue;switch(n.nodeName){case"link":this.links.push((new qt).parse(n));break;case"rotate":case"translate":case"matrix":this.transforms.push((new ft).parse(n));break;default:}}return this},{load:k,parse:L,setPreferredShading:A,applySkin:z,geometries:f,options:x}};